@page "/add"
@page "/edit/{Id:int}"
@using KdyBylUklid.Data
@inject AppDbContext Db
@inject NavigationManager Nav

<PageTitle>@(Id.HasValue ? "Upravit z√°znam" : "Nov√Ω z√°znam")</PageTitle>

<div class="container">
    <h1>@(Id.HasValue ? "Upravit z√°znam" : "Nov√Ω z√°znam")</h1>

    <section class="form-section">
        <EditForm Model="Model" OnSubmit="Save" FormName="cleaning-form" Enhance>

            <div class="form-group">
                <label for="date">Datum</label>
                <input type="text" id="date" name="DateString" class="datepicker" value="@DateString" placeholder="d.m.rrrr" />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="timeFrom">Od</label>
                    <input type="text" id="timeFrom" name="TimeFromString" class="timepicker" value="@TimeFromString" placeholder="h:mm" />
                </div>

                <div class="form-group">
                    <label for="timeTo">Do</label>
                    <input type="text" id="timeTo" name="TimeToString" class="timepicker" value="@TimeToString" placeholder="h:mm" />
                </div>
            </div>

            <div class="form-group">
                <label>Poƒçet ukl√≠zeƒçek</label>
                <div class="cleaner-picker">
                    <button type="button" class="cleaner-btn @(Model.CleanerCount == 1 ? "active" : "")"
                            onclick="document.getElementById('cleanerCount').value = 1; this.parentElement.querySelectorAll('.cleaner-btn').forEach(b => b.classList.remove('active')); this.classList.add('active');">
                        1√óüë©‚Äçü¶∞
                    </button>
                    <button type="button" class="cleaner-btn @(Model.CleanerCount == 2 ? "active" : "")"
                            onclick="document.getElementById('cleanerCount').value = 2; this.parentElement.querySelectorAll('.cleaner-btn').forEach(b => b.classList.remove('active')); this.classList.add('active');">
                        2√óüë©‚Äçü¶∞
                    </button>
                    <input type="number" id="cleanerCount" name="CleanerCount" value="@Model.CleanerCount" min="1" max="10" class="cleaner-input" />
                </div>
            </div>

            @if (Id.HasValue)
            {
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="IsPaid" value="true" checked="@Model.IsPaid" />
                        <span>Zaplaceno</span>
                    </label>
                </div>
            }

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    @(Id.HasValue ? "Ulo≈æit" : "P≈ôidat")
                </button>
                <a href="/" class="btn btn-secondary">Zru≈°it</a>
            </div>
        </EditForm>

        @if (Id.HasValue)
        {
            <form method="post" @formname="delete" @onsubmit="Delete" class="delete-form" Enhance>
                <AntiforgeryToken />
                <button type="submit" class="btn-link-danger" onclick="return confirm('Opravdu smazat tento z√°znam?')">
                    Smazat z√°znam
                </button>
            </form>
        }
    </section>
</div>

@code {
    [Parameter]
    public int? Id { get; set; }

    public CleaningRecord Model { get; set; } = new();

    [SupplyParameterFromForm(Name = "DateString")]
    public string? DateStringForm { get; set; }

    [SupplyParameterFromForm(Name = "TimeFromString")]
    public string? TimeFromStringForm { get; set; }

    [SupplyParameterFromForm(Name = "TimeToString")]
    public string? TimeToStringForm { get; set; }

    [SupplyParameterFromForm(Name = "CleanerCount")]
    public int? CleanerCountForm { get; set; }

    [SupplyParameterFromForm(Name = "IsPaid")]
    public string? IsPaidForm { get; set; }

    private string DateString => Model.Date.ToString("d.M.yyyy");
    private string TimeFromString => Model.TimeFrom.ToString("H:mm");
    private string TimeToString => Model.TimeTo?.ToString("H:mm") ?? "";

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            var existing = await Db.CleaningRecords.FindAsync(Id.Value);
            if (existing != null)
                Model = existing;
            else
                Nav.NavigateTo("/");
        }
        else
        {
            Model.Date = DateOnly.FromDateTime(DateTime.Today);
            Model.TimeFrom = new TimeOnly(9, 0);
            Model.CleanerCount = 1;
        }
    }

    private async Task Save()
    {
        // Parse form values
        if (DateOnly.TryParse(DateStringForm, out var date))
            Model.Date = date;
        if (TimeOnly.TryParse(TimeFromStringForm, out var timeFrom))
            Model.TimeFrom = timeFrom;
        Model.TimeTo = TimeOnly.TryParse(TimeToStringForm, out var timeTo) ? timeTo : null;
        if (CleanerCountForm.HasValue)
            Model.CleanerCount = CleanerCountForm.Value;
        Model.IsPaid = IsPaidForm == "true";

        if (Id.HasValue)
        {
            var existing = await Db.CleaningRecords.FindAsync(Id.Value);
            if (existing != null)
            {
                existing.Date = Model.Date;
                existing.TimeFrom = Model.TimeFrom;
                existing.TimeTo = Model.TimeTo;
                existing.CleanerCount = Model.CleanerCount;
                existing.IsPaid = Model.IsPaid;
                await Db.SaveChangesAsync();
            }
        }
        else
        {
            Model.CreatedAt = DateTime.UtcNow;
            Db.CleaningRecords.Add(Model);
            await Db.SaveChangesAsync();
        }

        Nav.NavigateTo("/");
    }

    private async Task Delete()
    {
        if (Id.HasValue)
        {
            var record = await Db.CleaningRecords.FindAsync(Id.Value);
            if (record != null)
            {
                Db.CleaningRecords.Remove(record);
                await Db.SaveChangesAsync();
            }
        }
        Nav.NavigateTo("/");
    }
}
